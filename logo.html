<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>第一个three.js文件_WebGL三维场景</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .text-sprite {
            transition: transform 0.3s;
            cursor: pointer;
        }

        .text-sprite:hover {
            transform: scale(2);
            cursor: pointer;
        }
    </style>
    <!--引入three.js三维引擎-->
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/100/three.js"></script>
    <script src="https://wow.techbrood.com/uploads/150501/OrbitControls.js"></script>
</head>

<body>
    <div id="canvas-container"></div>
    <script>
        /**
         * 创建场景对象Scene
         */
        var scene = new THREE.Scene();

        /**
         * 光源设置
         */
        //点光源
        var point = new THREE.PointLight(0xffffff);
        point.position.set(400, 200, 300); //点光源位置
        //scene.add(point); //点光源添加到场景中
        //环境光
        var ambient = new THREE.AmbientLight(0x444444);
        scene.add(ambient);

        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();
        var selectedSprite = null;

        /**
         * 相机设置
         */
        var width = window.innerWidth; //窗口宽度
        var height = window.innerHeight; //窗口高度

        var camera = new THREE.PerspectiveCamera(40, width / height, 1, 10000);
        camera.position.set(0, 0, 3000);

        function createTextSprite(text) {
            var size = 100;
            var canvas = document.createElement("canvas");
            var context = canvas.getContext("2d");

            var fontSize = size * 0.25;
            context.font = "bold " + fontSize + "px Arial";
            var textWidth = context.measureText(text).width;

            canvas.width = textWidth;
            canvas.height = size;

            context.font = "bold " + fontSize + "px Arial";
            context.textBaseline = "middle";
            context.textAlign = "center";
            context.fillStyle = "#ffffff";

            // hover上去鼠标为point

            context.fillText(text, textWidth / 2, size / 2);

            var texture = new THREE.CanvasTexture(canvas);
            texture.generateMipmaps = false;
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;

            var material = new THREE.SpriteMaterial({ map: texture });
            var sprite = new THREE.Sprite(material);
            sprite.scale.set(textWidth, size, 1);

            sprite.userData = {
                text: text,
                size: size,
                originalScale: sprite.scale.clone(),
                link: `https://www.moledao.io/#/event/${text}`
            };

            return sprite;
        }

        var group = new THREE.Group();

        function addText(text, position) {
            var sprite = createTextSprite(text);
            sprite.position.copy(position);
            sprite.onmouseenter = function () {
                controls.enabled = false;
            };
            sprite.onmouseleave = function () {
                controls.enabled = true;
            };

            group.add(sprite);
        }

        function addCircle(position) {
            var geometry = new THREE.CircleGeometry(8, 60);
            // 生成一个随机颜色
            var color = Math.random() * 0xffffff;
            var material = new THREE.MeshBasicMaterial({ color });
            var circle = new THREE.Mesh(geometry, material);
            circle.position.copy(position);
            circle.position.y -= 25;
            group.add(circle);
        }

        for (var i = 0, l = 40; i < l; i++) {
            var phi = Math.acos(-1 + (2 * i) / l);
            var theta = Math.sqrt(l * Math.PI) * phi;

            var text = [...Array(Math.floor(Math.random() * 18) + 3)]
                .map(() => String.fromCharCode(97 + Math.floor(Math.random() * 26)))
                .join('');
            var position = new THREE.Vector3().setFromSphericalCoords(800, phi, theta);

            addText(text, position);
            // addCircle(position);
        }

        scene.add(group);

        /**
         * 创建渲染器对象
         */
        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height); //设置渲染区域尺寸
        renderer.shadowMap.enabled = false;
        //renderer.setClearColor(0xb9d3ff, 1); //设置背景颜色
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById("canvas-container").appendChild(renderer.domElement); //将 canvas 添加到容器中

        /**
         * 创建控制器对象
         */
        var controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableRotate = false; // 禁止相机旋转

        /**
         * 鼠标事件处理
         */
        function onMouseMove(event) {
            // 计算鼠标的归一化设备坐标
            mouse.x = (event.clientX / width) * 2 - 1;
            mouse.y = -(event.clientY / height) * 2 + 1;

            // 通过射线法进行碰撞检测
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects(group.children);

            if (intersects.length > 0) {
                if (selectedSprite) {
                    selectedSprite.scale.copy(selectedSprite.userData.originalScale);
                    selectedSprite = null;
                }

                var intersect = intersects[0];
                var sprite = intersect.object;

                sprite.scale.multiplyScalar(2);
                selectedSprite = sprite;
            } else if (selectedSprite) {
                selectedSprite.scale.copy(selectedSprite.userData.originalScale);
                selectedSprite = null;
            }
        }

        function onWindowResize() {
            width = window.innerWidth;
            height = window.innerHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);

        /**
         * 渲染函数
         */
        function render() {
            renderer.render(scene, camera); //执行渲染操作
            group.rotateY(-0.001); //每次绕y轴旋转0.01弧度
            group.rotateX(0.001);

            group.children.forEach(function (child) {
                // 如果是圆点对象，更新其朝向
                // const circle = child.children[1];
                // circle.lookAt(camera.position);
                if (child instanceof THREE.Mesh) {
                    child.lookAt(camera.position);
                }
                // var textPos = child.children[0].position.clone();
                // circle.position.copy(textPos);
                // console.log(textPos)
                // circle的y始终都是面对着摄像机的时候的文字的正下方中间
                // circle.position.y = textPos.y  - 40

            });

            controls.update();
            requestAnimationFrame(render); //请求再次执行渲染函数render
        }

        function onMouseClick(event) {
            mouse.x = (event.clientX / width) * 2 - 1;
            mouse.y = -(event.clientY / height) * 2 + 1;

            // 通过射线法进行碰撞检测
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects(group.children);

            if (intersects.length > 0) {
                var intersect = intersects[0];
                var sprite = intersect.object;

                if (sprite?.userData && sprite?.userData?.link) {
                    window.open(sprite.userData.link, "_blank")
                }
            }
            // ...
        }
        window.addEventListener('click', onMouseClick, false);

        render();
    </script>
</body>

</html>